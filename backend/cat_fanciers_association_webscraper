import cloudscraper
from bs4 import BeautifulSoup
import time
import csv

# --- CONFIGURATION ---
CFA_INDEX_URL = "https://cfa.org/breeds/"
CFA_CSV_FILENAME = "cfa_breeds_2025.csv"

def get_breed_links():
    # 'cloudscraper' bypasses common bot-detection screens
    scraper = cloudscraper.create_scraper() 
    print(f"üì° Accessing CFA Index...")
    
    try:
        response = scraper.get(CFA_INDEX_URL)
        if response.status_code != 200:
            print(f"‚ùå Blocked! Status Code: {response.status_code}")
            return []

        soup = BeautifulSoup(response.text, 'html.parser')
        breed_links = []
        
        # CFA's 2025 structure uses 'wp-block-columns' or 'wp-block-image' 
        # for their breed grid. We search for links with breed names.
        # We target links that are direct children of the breed list.
        for link in soup.find_all('a', href=True):
            url = link['href']
            name = link.get_text(strip=True)
            
            # Logic: We want URLs that look like cfa.org/abyssinian/
            # We filter out generic nav links and resources
            if "cfa.org" in url and len(url.split('/')) >= 4:
                # Exclude common footer/header noise
                if any(x in url.lower() for x in ['contact', 'about', 'privacy', 'tag', 'category']):
                    continue
                if name and len(name) > 2:
                    breed_links.append({'name': name, 'url': url})

        # Remove duplicates
        unique_breeds = {v['url']: v for v in breed_links}.values()
        print(f"‚úÖ Found {len(unique_breeds)} unique breeds!")
        return list(unique_breeds)

    except Exception as e:
        print(f"‚ö†Ô∏è Error: {e}")
        return []

if __name__ == "__main__":
    breeds = get_breed_links()
    if breeds:
        with open(CFA_CSV_FILENAME, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=['name', 'url'])
            writer.writeheader()
            writer.writerows(breeds)
        print(f"üìÇ Saved to {CFA_CSV_FILENAME}")
    else:
        print("Still 0 links. The site may require a Headless Browser (Selenium).")